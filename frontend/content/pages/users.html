<!-- <style>
    /* Custom CSS for scrollable table */
    .table-container {
        max-height: 20vh;
        overflow-y: auto;
        border: 1px solid white;
        border-radius: 15px;
        background: var(--sec-bg-color);
    }

    /* Make the table header sticky */
    .table thead th {
        color: white;
        position: sticky;
        top: 0;
        background-color: var(--sec-bg-color);
        z-index: 1;
    }

    .table td {
        color: white;
        background-color: var(--sec-bg-color);
    }

    .table-header {
        border: 1px solid white;
    }
</style>
<div>
    <div>
        <h2>Список пользователей</h2>
        <div class="table-container">
            <table class="table table-bordered table-striped text-white">
                <thead>
                    <tr>
                        <th class="table-header">ID</th>
                        <th class="table-header">Имя пользователя</th>
                        <th class="table-header">Доп.инфо</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Row 1, Column 1</td>
                        <td>Row 1, Column 2</td>
                        <td>Row 1, Column 3</td>
                    </tr>
                    <tr>
                        <td>Row 2, Column 1</td>
                        <td>Row 2, Column 2</td>
                        <td>Row 2, Column 3</td>
                    </tr>
                    <tr>
                        <td>Row 3, Column 1</td>
                        <td>Row 3, Column 2</td>
                        <td>Row 3, Column 3</td>
                    </tr>
                    <tr>
                        <td>Row 4, Column 1</td>
                        <td>Row 4, Column 2</td>
                        <td>Row 4, Column 3</td>
                    </tr>
                    <tr>
                        <td>Row 5, Column 1</td>
                        <td>Row 5, Column 2</td>
                        <td>Row 5, Column 3</td>
                    </tr>
                    <tr>
                        <td>Row 6, Column 1</td>
                        <td>Row 6, Column 2</td>
                        <td>Row 6, Column 3</td>
                    </tr>
                    <tr>
                        <td>Row 7, Column 1</td>
                        <td>Row 7, Column 2</td>
                        <td>Row 7, Column 3</td>
                    </tr>
                    <tr>
                        <td>Row 8, Column 1</td>
                        <td>Row 8, Column 2</td>
                        <td>Row 8, Column 3</td>
                    </tr>
                    <tr>
                        <td>Row 9, Column 1</td>
                        <td>Row 9, Column 2</td>
                        <td>Row 9, Column 3</td>
                    </tr>
                    <tr>
                        <td>Row 10, Column 1</td>
                        <td>Row 10, Column 2</td>
                        <td>Row 10, Column 3</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <hr>
    <div>
        <h2>Удаление/добавление/изменение</h2>
    </div>
    <hr>
    <div>
        <h2>Доп пространство</h2>
    </div>
</div> -->
<style>
    /* Custom CSS for scrollable table */
    .table-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
    }

    .table thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 1;
    }

    .editable-input {
        width: 100%;
        border: none;
        background: transparent;
    }
</style>


<div class="container mt-4">
    <h2>User Management Table</h2>

    <!-- Input fields for adding a new user -->
    <div class="mb-3">
        <input type="text" id="username" class="form-control" placeholder="Username">
        <input type="password" id="password" class="form-control mt-2" placeholder="Password">
        <input type="text" id="additional_info" class="form-control mt-2" placeholder="Additional Data (JSON)">
        <button class="btn btn-primary mt-2" onclick="addUser()">Add User</button>
    </div>

    <!-- Scrollable table -->
    <div class="table-container">
        <table id="userTable" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>ID</th> <!-- Locked column -->
                    <th>Username</th>
                    <th>Password</th>
                    <th>Additional Data</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated dynamically -->
            </tbody>
        </table>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- CryptoJS for SHA-512 hashing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
    const sessionKey = localStorage.getItem("real_lab_conf"); // Replace with your session key

    // Fetch users from the server and populate the table
    async function fetchUsers() {
        try {
            const response = await fetch('/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ session_token: sessionKey }),
            });
            const users = await response.json();
            console.log(users)
            populateTable(users);
        } catch (error) {
            console.error('Error fetching users:', error);
        }
    }

    // Populate the table with user data
    function populateTable(users) {
        const tbody = document.querySelector('#userTable tbody');
        tbody.innerHTML = ''; // Clear existing rows

        users.forEach(user => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = user.id; // Locked column
            row.insertCell(1).textContent = user.username;
            row.insertCell(2).textContent = user.password; // Passwords are returned as ***
            row.insertCell(3).textContent = user.additional_info;
            // console.log(user)

            // Add edit and delete buttons
            const actionCell = row.insertCell(4);
            const editButton = document.createElement('button');
            editButton.textContent = 'Edit';
            editButton.className = 'btn btn-warning btn-sm me-2';
            editButton.onclick = () => editUser(row);
            actionCell.appendChild(editButton);

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'btn btn-danger btn-sm';
            deleteButton.onclick = () => deleteUser(user.id);
            actionCell.appendChild(deleteButton);
        });
    }

    // Add a new user
    async function addUser() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const additional_info = document.getElementById('additional_info').value;

        if (!username || !password || !additional_info) {
            alert('Please fill all fields!');
            return;
        }

        // Hash the password using SHA-512
        const hashedPassword = CryptoJS.SHA512(password).toString();

        try {
            const response = await fetch('/add_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_token: sessionKey,
                    userdata: {
                        username,
                        password: hashedPassword,
                        additional_info: additional_info,
                    },
                }),
            });

            if (response.ok) {
                fetchUsers(); // Refresh the table
            } else {
                console.error('Error adding user:', await response.text());
            }
        } catch (error) {
            console.error('Error adding user:', error);
        }
    }

    // Delete a user
    async function deleteUser(userId) {
        try {
            const response = await fetch('/rem_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_token: sessionKey,
                    userdata: { id: userId },
                }),
            });

            if (response.ok) {
                fetchUsers(); // Refresh the table
            } else {
                console.error('Error deleting user:', await response.text());
            }
        } catch (error) {
            console.error('Error deleting user:', error);
        }
    }

    // Edit a user
    async function editUser(row) {
        const cells = row.cells;
        const userId = cells[0].textContent; // Locked ID column

        // Toggle between text and input fields
        for (let i = 1; i < cells.length - 1; i++) {
            const cell = cells[i];
            if (cell.querySelector('input')) {
                // Save the value and switch back to text
                const input = cell.querySelector('input');
                cell.textContent = input.value;
            } else {
                // Switch to input field
                const currentValue = cell.textContent;
                console.log(currentValue)
                cell.innerHTML = `<input type="text" class="editable-input" value="${currentValue}">`;
            }
        }

        // Change the button text to "Save" or "Edit"
        const editButton = row.querySelector('button');
        if (editButton.textContent === 'Edit') {
            editButton.textContent = 'Save';
        } else {
            editButton.textContent = 'Edit';

            // Prepare updated user data
            const updatedUser = {
                id: userId,
                username: cells[1].textContent,
                password: cells[2].textContent === '***' ? '***' : CryptoJS.SHA512(cells[2].textContent).toString(),
                additional_info: cells[3].textContent,
            };

            // Send the updated data to the server
            try {
                const response = await fetch('/alter_user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_token: sessionKey,
                        userdata: updatedUser,
                    }),
                });

                if (!response.ok) {
                    console.error('Error updating user:', await response.text());
                }
            } catch (error) {
                console.error('Error updating user:', error);
            }
        }
    }

    // Fetch users when the page loads
    fetchUsers();
</script>